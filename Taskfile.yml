# https://taskfile.dev

version: '3'

vars:
  PORT: 3000

env:
  APP_PORT: "{{ .PORT }}"

tasks:

  install:
    run: once
    sources:
      - package.json
      - yarn.lock
    cmds:
      - yarn

  dev:
    deps: [install]
    cmds:
      - npx nest start --watch

  format:
    deps: [install]
    cmds:
      - yarn format

  lint:
    deps: [install, format]
    cmds:
      - yarn lint

  test:
    deps: [install, lint]
    cmds:
      - npx vitest run

  test:watch:
    deps: [install]
    cmds:
      - npx vitest watch

  serve:
    cmds:
      - docker compose up --build -d
      - docker compose logs -f

  test:integration:
    dir: test/specs
    silent: true
    cmds:
      - >
        hurl
        --test
        --parallel
        --jobs {{ .JOBS }}
        --variable API_KEY={{ .API_KEY }}
        --variable APP_URL={{ .APP_URL }}
        ./**/*.hurl
    vars:
      JOBS: 4
      APP_URL: "http://localhost:{{ .PORT }}"
      API_KEY:
        sh: op read "op://Employee/OpenAI/Security/API_KEY"
